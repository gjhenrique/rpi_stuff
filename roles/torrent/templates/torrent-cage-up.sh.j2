#!/usr/bin/env bash

set -xe

ip netns add torrent

ip netns exec torrent iptables -A OUTPUT -d 127.0.0.1 -j ACCEPT
ip netns exec torrent iptables -A OUTPUT ! -o tun0 -m mark ! --mark "0xca6c" -m addrtype ! --dst-type LOCAL -m owner --gid-owner {{ torrent_user_gid_owner }} -j REJECT
ip netns exec torrent ip6tables -A OUTPUT ! -o tun0 -m mark ! --mark "0xca6c" -m addrtype ! --dst-type LOCAL -m owner --gid-owner 1500 -j REJECT

mkdir -p /etc/netns/torrent

echo nameserver 1.1.1.1 > /etc/netns/torrent/resolv.conf

ip link add veth_host type veth peer name veth_torrent
ip link set veth_torrent netns torrent

ip addr add {{ torrent_cage_host_ip }}/24 dev veth_host
ip link set veth_host up

ip -n torrent addr add {{ torrent_cage_torrent_ip }}/24 dev veth_torrent
ip -n torrent link set lo up
ip -n torrent link set veth_torrent up
ip -n torrent route add default via {{ torrent_cage_host_ip }}
