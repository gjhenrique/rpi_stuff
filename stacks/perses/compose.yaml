---
services:
  postgres:
    image: postgres:16-alpine
    container_name: perses-postgres
    network_mode: host
    restart: unless-stopped
    volumes:
      - ${EXT_PATH}/perses/postgres:/var/lib/postgresql/data
    environment:
      - POSTGRES_USER=${PERSES_DB_USERNAME:-perses}
      - POSTGRES_PASSWORD=${PERSES_DB_PASSWORD}
      - POSTGRES_DB=${PERSES_DB_NAME:-perses}
      - TZ=${TZ:-Europe/Berlin}
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${PERSES_DB_USERNAME:-perses}"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

  perses:
    image: persesdev/perses:latest
    container_name: perses
    network_mode: host
    restart: unless-stopped
    command: ["--config=${PERSES_CONFIG_FILE:-/var/lib/perses/perses-config.yml}", "--log.level=info"]
    volumes:
      - ${EXT_PATH}/perses/config:/etc/perses
      - ${EXT_PATH}/perses/dashboards:/var/lib/perses/dashboards
      - ${EXT_PATH}/perses/datasources:/var/lib/perses/datasources
      - ./perses-config.yml:/var/lib/perses/perses-config.yml
    environment:
      - PERSES_CONFIG_FILE=${PERSES_CONFIG_FILE:-/etc/perses/perses-config.yml}
      - PERSES_DATABASE_POSTGRESQL_HOST=localhost
      - PERSES_DATABASE_POSTGRESQL_PORT=5432
      - PERSES_DATABASE_POSTGRESQL_USER=${PERSES_DB_USERNAME:-perses}
      - PERSES_DATABASE_POSTGRESQL_PASSWORD=${PERSES_DB_PASSWORD}
      - PERSES_DATABASE_POSTGRESQL_DBNAME=${PERSES_DB_NAME:-perses}
      - TZ=${TZ:-Europe/Berlin}
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://localhost:8080/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    depends_on:
      postgres:
        condition: service_healthy
